DESCRIPTION DÉTAILLÉE DU PROCESSUS D'IMPORTATION DES DONNÉES (au 25/07/2024)

Ce document décrit avec précision le mécanisme actuel par lequel l'application importe et gère les données depuis les Google Sheets. Il inclut également ma compréhension de vos objectifs pour le projet "CYBER CLUB".


======================================================================
PARTIE 1 : COMPRÉHENSION DE VOS INTENTIONS POUR LE PROJET "CYBER CLUB"
======================================================================

---
### Vision d'ensemble (résumé)
---
Vous souhaitez construire une plateforme web dynamique et modulable ("CYBER CLUB") qui fonctionne comme un portfolio multi-marques, un catalogue de produits/projets, et potentiellement un site e-commerce. La caractéristique centrale du projet est que **l'intégralité du contenu et de la structure du site doit être pilotée par des Google Sheets**, permettant des mises à jour en temps réel sans intervention sur le code.

---
### Objectifs détaillés
---
1.  **Architecture 100% "Data-Driven"** :
    *   **Source de vérité unique** : Les Google Sheets sont le cerveau de l'application. Le code n'est qu'un "moteur" qui interprète et affiche les données.
    *   **Gestion de contenu décentralisée** : Vous (ou d'autres) devez pouvoir modifier le contenu, ajouter des projets, des produits ou même des catégories entières en éditant simplement des cellules dans une feuille de calcul.

2.  **Navigation et Structure Dynamiques** :
    *   Le menu de navigation principal n'est pas codé en dur. Il est généré automatiquement en lisant les lignes du **"Master Sheet"**.
    *   **Scalabilité** : Si vous ajoutez une nouvelle ligne pour une catégorie "Blog" dans le Master Sheet, un lien "Blog" doit apparaître automatiquement dans le header, créant une nouvelle page fonctionnelle.

3.  **Système de "Marques" (Branding) Adaptatif** :
    *   Le **"Brand Selector"** est un élément clé. Il est lui-même alimenté par le "Brand Sheet".
    *   **Thématisation dynamique** : Sélectionner une marque (ex: "Artefact") doit instantanément changer l'identité visuelle du site (couleurs d'accentuation, ombres, etc.) en se basant sur les styles définis dans le Brand Sheet.
    *   **Routage contextuel** : L'URL doit refléter la marque active, passant d'une structure par défaut (`/projects`) à une structure de marque (`/design/projects`).
    *   **Filtrage de contenu** (objectif futur) : À terme, la sélection d'une marque ne changera pas seulement le style, mais filtrera aussi le contenu affiché sur la page pour ne montrer que les éléments pertinents à cette marque.


======================================================================
PARTIE 2 : FONCTIONNEMENT TECHNIQUE ACTUEL DE L'IMPORTATION
======================================================================

Le processus se déroule principalement dans le fichier `src/lib/sheets.ts` et peut être décomposé en 3 étapes majeures.

---
### Étape 1 : Récupération des Catégories (depuis le Master Sheet)
---
1.  **Appel Initial** : Tout commence par un appel à la fonction `getCategories()`. Cette fonction est la porte d'entrée pour connaître la structure de base du site (les pages comme Home, Projects, Catalog, etc.).

2.  **Mise en Cache (`unstable_cache`)** : Pour optimiser les performances et ne pas solliciter l'API de Google à chaque visite, le résultat de cette fonction est mis en cache. La durée de validité est de 5 minutes (`revalidate: 300`). Cela signifie que si vous modifiez le Master Sheet, le site mettra jusqu'à 5 minutes pour refléter le changement.

3.  **Fetch du CSV** : La fonction utilise `fetch` pour télécharger le contenu brut du "Master Sheet" via son URL de publication CSV :
    `.../pub?gid=177392102&single=true&output=csv`

4.  **Parsing du CSV en Objets** : Le texte CSV obtenu est ensuite analysé (par la fonction `fetchAndParseCsv`) pour être transformé en un tableau d'objets JavaScript. Chaque objet représente une ligne du Master Sheet, et donc une catégorie du site.
    *Exemple d'objet généré :* `{ "Name": "Projects", "Slug": "projects", "Url Sheet": "...", ... }`

---
### Étape 2 : Correctif Temporaire des GIDs (Le "Pansement" Actuel)
---
C'est l'étape la plus critique, mise en place pour **contourner les `gid` incorrects** que vous aviez identifiés dans le Master Sheet. Cette logique se trouve directement à la fin de la fonction `getCategories`.

1.  **Définition d'une "Carte de Correction" (`gidCorrectionMap`)** : Un objet JavaScript statique est défini dans le code. Il sert de table de correspondance entre le nom d'une catégorie et le `gid` **correct** de la feuille de calcul qui lui est associée.

    *Extrait de la carte de correction dans le code :*
    ```javascript
    const gidCorrectionMap = {
      'Home': '177392102', // Reste le master, car pas de feuille dédiée identifiée
      'Projects': '153094389',
      'Catalog': '581525493',
      'Tools': '990396131',
      // ... etc. pour toutes les catégories.
    };
    ```

2.  **Vérification et Remplacement "à la volée"** : Le code parcourt ensuite chaque objet "catégorie" qui vient d'être créé à partir du Master Sheet.
    *   Pour chaque catégorie (ex: "Projects"), il extrait le `gid` présent dans sa propriété `'Url Sheet'` (qui est le mauvais `gid` venant du CSV).
    *   Il compare ce `gid` avec le `gid` correct qui est stocké dans la `gidCorrectionMap` pour cette même catégorie.
    *   **Si les `gid` ne correspondent pas**, le code ignore l'URL erronée du Master Sheet et en construit une **nouvelle**, en utilisant la base de l'URL et en y injectant le `gid` correct tiré de `gidCorrectionMap`.

    **C'est grâce à cette étape de correction en mémoire que les pages "Projects", "Catalog", etc., chargent désormais les bonnes données, même si le Master Sheet lui-même contient toujours les mauvais liens.** C'est un pansement efficace mais temporaire.

---
### Étape 3 : Récupération des Données Spécifiques à une Page
---
1.  **Navigation de l'utilisateur** : Lorsque vous cliquez sur un lien du menu (ex: "Projects"), le navigateur charge l'URL correspondante (ex: `/projects`).

2.  **Exécution de la Page Dynamique** : Le composant de page `src/app/[...slug]/page.tsx` s'exécute. Il analyse l'URL (`/projects`) pour identifier la catégorie demandée ("projects").

3.  **Appel de `getCategoryData`** : Le composant trouve l'objet "catégorie" correspondant (qui contient maintenant l'URL de la feuille **corrigée** à l'étape 2) et passe cette URL à la fonction `getCategoryData(sheetUrl)`.

4.  **Fetch des Données Finales** : `getCategoryData` prend cette URL corrigée et effectue un nouveau `fetch` pour récupérer le CSV de la feuille de calcul spécifique (par exemple, la feuille de données des projets).

5.  **Parsing et Affichage** : Les données de cette feuille spécifique sont parsées et finalement affichées sur la page, dans la section "Données brutes de la feuille".

**En résumé :** Le système fonctionne actuellement en deux temps. Il charge une liste de catégories depuis le Master Sheet, applique immédiatement un correctif en mémoire pour réparer les URLs des feuilles de calcul qui sont erronées à la source, puis utilise ces URLs corrigées pour charger et afficher les données réelles de la page que vous visitez.