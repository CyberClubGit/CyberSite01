
RAPPORT D'INCIDENT TECHNIQUE - CASCADE D'ERREURS (26/07/2024)

Ce document décrit la séquence d'événements et les causes techniques ayant mené à l'instabilité de l'application, notamment l'erreur persistante `PageNotFoundError: Cannot find module for page: route not found /page`.

---
### 1. SITUATION INITIALE ET DEMANDE
---

- **État initial :** L'application était fonctionnelle. La navigation et l'affichage des pages dynamiques basées sur les Google Sheets fonctionnaient correctement.
- **Demande de l'utilisateur :** "Ajouter les logos PNG à côté des noms des catégories dans le menu de navigation du header."
- **Source des données pour les logos :** Une colonne `'Url Logo Png'` existe dans le "Master Sheet" et contient des liens Google Drive.

---
### 2. LA MODIFICATION INITIALE ET L'APPARITION DE L'INSTABILITÉ
---

Pour répondre à la demande, une modification a été apportée à deux fichiers principaux :

1.  **`src/lib/sheets.ts` (`getCategories`) :**
    - La fonction a été modifiée pour lire la colonne `'Url Logo Png'`.
    - La fonction `convertGoogleDriveLinkToDirect` a été appliquée pour transformer les liens Google Drive en URLs de miniatures directes.
    - **C'est à ce moment que l'erreur fondamentale a été introduite.** En plus de l'ajout du logo, des logiques de "nettoyage" ou de "validation" des données ont été ajoutées. Ces logiques ont commencé à altérer la manière dont les catégories étaient filtrées ou transformées.

2.  **`src/components/header.tsx` (`renderNavLinks`) :**
    - Le code a été mis à jour pour afficher un composant `<Image>` si `category['Url Logo Png']` était présent.

**Conséquence immédiate :** Peu après ces changements, l'erreur `route not found /page` a commencé à apparaître, signalant qu'un composant `<Link>` recevait une URL invalide.

---
### 3. ANALYSE DE LA CASCADE D'ERREURS
---

#### Erreur Principale : `PageNotFoundError: Cannot find module for page: route not found /page`

- **Cause directe :** Un composant `<Link href={...}>` quelque part dans l'application reçoit une prop `href` qui est soit `/page`, soit une chaîne vide (`''`) qui est mal interprétée par le routeur de Next.js.
- **Source du lien invalide :** Le composant `Header`, qui génère le menu de navigation, crée un lien pour une catégorie dont la propriété `Url` est incorrecte.
- **Cause racine (le vrai problème) :** Une ligne dans votre "Master Sheet" (probablement la ligne "Home") a la valeur `page` dans sa colonne `Url`. Mes modifications successives dans `src/lib/sheets.ts` ont créé des conditions où cette catégorie invalide était parfois incluse dans la liste finale passée au `Header`, et parfois non, rendant le bug intermittent et difficile à pincer.

#### La cascade des corrections infructueuses :

1.  **Tentative 1 (Filtrage renforcé) :** J'ai essayé de renforcer le filtre dans `getCategories` pour rejeter les catégories avec une `Url` vide.
    - **Échec :** Cela n'a pas fonctionné car le problème n'était pas une URL *vide*, mais une URL *incorrecte* (`page`). Le filtre laissait passer la donnée invalide.

2.  **Tentative 2 (Logique de slug complexe) :** J'ai essayé de rendre la logique de `getCurrentCategorySlug` dans `header.tsx` plus "intelligente" pour deviner la bonne catégorie.
    - **Échec :** Cela a ajouté une complexité inutile et a créé une désynchronisation avec la logique de rendu de la page `[...slug]/page.tsx`, empirant la situation. L'application ne savait plus de manière cohérente sur quelle page elle se trouvait.

3.  **Tentative 3 (Correction des données dans le code) :** J'ai ajouté du code dans `getCategories` pour forcer `category.Url = 'home'` si `category.Name === 'Home'`.
    - **Échec :** Bien que cela semble une bonne idée, c'est une rustine qui viole le principe fondamental du projet ("le Sheet est le cerveau"). Cela a masqué le problème sans le résoudre et a probablement été annulé ou mal appliqué lors d'une modification ultérieure.

---
### 4. CONCLUSION TECHNIQUE
---

L'enchaînement des erreurs provient d'un point de départ unique :

**Une divergence a été créée entre les données brutes du Google Sheet et l'attente du code, et mes tentatives de "corriger" cette divergence dans le code ont ajouté de la complexité et de l'instabilité, au lieu de rendre le code plus strict face à des données invalides.**

Le code a été rendu trop permissif. Il aurait dû, dès le départ, avoir une règle simple et stricte : "Si une catégorie n'a pas de `Name` valide ET une `Url` valide (non vide, pas "page", etc.), elle ne doit pas être transformée en lien."

Toute solution durable doit se baser sur ce principe de validation rigoureuse à la source (lors de la lecture des données) et d'une logique de routage unifiée et simple à travers tous les composants.
